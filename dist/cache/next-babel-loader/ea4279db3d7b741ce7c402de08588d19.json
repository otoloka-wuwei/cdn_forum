{"ast":null,"code":"var _jsxFileName = \"D:\\\\otoProject\\\\workspace\\\\otoloka-mobile-forum\\\\components\\\\comment-item\\\\index.tsx\";\nvar __jsx = React.createElement;\nimport React, { useState, useEffect, useRef, useContext } from 'react';\nimport './index.scss';\nimport { useObserver, MobXProviderContext } from 'mobx-react';\nimport UserAvatar from '../user-avatar';\nimport CommentReplyItem from '../comment-reply-item';\nimport { CommentInputSubject } from '../../subject/comment';\nimport { Toast, Modal } from 'antd-mobile';\nimport DetailService from '../../services/detail';\nimport Loading from '../loading';\nimport { DomChangeSubject } from '../../subject/dom';\n\nconst CommentItem = ({\n  data\n}) => {\n  const {\n    0: isMore,\n    1: setIsMore\n  } = useState(false);\n  const {\n    0: isMoreLoading,\n    1: setIsMoreLoading\n  } = useState(false);\n  const pageSize = 10;\n  const pageNum = useRef(1);\n  const {\n    0: commentReplyList,\n    1: setCommentReplyList\n  } = useState([]);\n  const commentReplyListRef = useRef([]);\n  const totalReply = useRef(0);\n  const isFirsPaegeLoad = useRef(false);\n  const {\n    store\n  } = useContext(MobXProviderContext);\n  const {\n    user\n  } = useObserver(() => ({\n    user: store.user\n  }));\n  const service = new DetailService();\n  useEffect(() => {\n    if (data) {\n      pageNum.current = 1;\n      isFirsPaegeLoad.current = false;\n      service.getSecondMessagesList(data.id, 1, pageSize).then(({\n        list,\n        total\n      }) => {\n        totalReply.current = total;\n        list.map(item => {\n          item.articleUserId = data.articleUserId;\n          return item;\n        });\n        commentReplyListRef.current = list;\n        setCommentReplyList(list.filter((item, index) => index < 3));\n        setIsMore(3 < total);\n      });\n      const commentSubscription = CommentInputSubject.subscribe(({\n        action,\n        messageData\n      }) => {\n        if (action === 'refresh-reply' && messageData.parentMessageId === data.id) {\n          addCommentRely(messageData);\n        } else if (action === 'delete-reply' && messageData.parentMessageId === data.id) {\n          deleteCommentReply(messageData.id, messageData.content);\n        }\n      });\n      return () => {\n        commentSubscription.unsubscribe();\n      };\n    }\n  }, [data]); //新增一条回复\n\n  const addCommentRely = replyItem => {\n    setCommentReplyList(commentReplyList => [...commentReplyList, replyItem]);\n  }; //删除一条回复\n\n\n  const deleteCommentReply = (replyId, content) => {\n    setCommentReplyList(commentReplyList => commentReplyList.filter(item => {\n      if (item.id === replyId) {\n        item.content = content;\n        item.status = 2;\n        return item;\n      } else {\n        return item;\n      }\n    }));\n  };\n\n  const getData = () => {\n    setIsMoreLoading(true);\n    return service.getSecondMessagesList(data.id, pageNum.current, pageSize).then(({\n      list,\n      total\n    }) => {\n      list.map(item => {\n        item.articleUserId = data.articleUserId;\n        return item;\n      });\n      setCommentReplyList(currentArticleList => [...currentArticleList.filter(item => item), ...list]);\n      setIsMoreLoading(false);\n\n      if (pageSize * pageNum.current >= total) {\n        setIsMore(false);\n      }\n    });\n  }; //加载更多\n\n\n  const handleExpandReplyComment = () => {\n    if (pageNum.current === 1 && totalReply.current > 3 && !isFirsPaegeLoad.current) {\n      //第一次加载\n      setCommentReplyList([...commentReplyListRef.current]);\n      isFirsPaegeLoad.current = true;\n\n      if (pageSize >= totalReply.current) {\n        setIsMore(false);\n      }\n    } else {\n      pageNum.current += 1;\n      getData().then(() => {\n        DomChangeSubject.next();\n      });\n    }\n  };\n\n  const handelReply = () => {\n    //发送 订阅 输入框\n    data.parentMessageUserid = data.messageUserid;\n    data.parentMessageId = data.id;\n    CommentInputSubject.next({\n      action: 'reply',\n      messageData: data\n    });\n  };\n\n  const handelDelete = () => {\n    Modal.alert('Yakin mau hapus?', 'Hapus', [{\n      text: 'Tidak',\n      onPress: () => {},\n      style: 'cancel'\n    }, {\n      text: 'Ya, keluar',\n      onPress: () => {\n        service.deleteMessage(data.id).then(resp => {\n          Toast.success('Berhasil menghapus!', 1);\n          CommentInputSubject.next({\n            action: 'delete-comment',\n            messageData: resp\n          }); //删除一级评论列表\n        }).catch(error => {\n          console.error(error);\n          Toast.success('Gagal menghapus!', 2);\n        });\n      }\n    }]);\n  };\n\n  return data ? __jsx(\"div\", {\n    className: \"comment-item-container\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 5\n    }\n  }, __jsx(\"div\", {\n    className: \"comment-item-avator\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 168,\n      columnNumber: 7\n    }\n  }, __jsx(UserAvatar, {\n    size: 0.36,\n    src: data.messageUserHeadUrl,\n    isAuthor: data.messageUserid === data.articleUserId,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 169,\n      columnNumber: 9\n    }\n  })), __jsx(\"div\", {\n    className: \"comment-item-content\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 7\n    }\n  }, __jsx(\"div\", {\n    className: \"main-message\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    className: \"main-message-content\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 173,\n      columnNumber: 11\n    }\n  }, __jsx(\"div\", {\n    className: \"message-user\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 13\n    }\n  }, __jsx(\"div\", {\n    className: \"message-user-name\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 175,\n      columnNumber: 15\n    }\n  }, data.messageUserName)), __jsx(\"div\", {\n    className: \"message-body\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 177,\n      columnNumber: 13\n    }\n  }, data.content)), __jsx(\"div\", {\n    className: \"message-operation\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 179,\n      columnNumber: 11\n    }\n  }, __jsx(\"div\", {\n    className: \"release-time\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 180,\n      columnNumber: 13\n    }\n  }, data.createTime), user && user.userId != data.messageUserid ? __jsx(\"div\", {\n    className: \"reply\",\n    onClick: handelReply,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 15\n    }\n  }, \"Balas\") : null, user && user.userId === data.messageUserid && data.status === 1 ? __jsx(\"div\", {\n    className: \"delete\",\n    onClick: handelDelete,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 15\n    }\n  }, \"Hapus\") : null)), __jsx(\"div\", {\n    className: \"message-reply-wrapper\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 9\n    }\n  }, __jsx(\"ul\", {\n    className: \"reply-list\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195,\n      columnNumber: 11\n    }\n  }, commentReplyList.map(item => __jsx(\"li\", {\n    className: \"reply-item\",\n    key: item.id,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 197,\n      columnNumber: 15\n    }\n  }, __jsx(CommentReplyItem, {\n    data: item,\n    parentMessageUserid: data.messageUserid,\n    parentMessageId: data.id,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 198,\n      columnNumber: 17\n    }\n  })))), isMore ? __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 208,\n      columnNumber: 13\n    }\n  }, isMoreLoading ? __jsx(Loading, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 209,\n      columnNumber: 32\n    }\n  }) : null, __jsx(\"div\", {\n    className: \"more-reply-wrapper\",\n    onClick: handleExpandReplyComment,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 210,\n      columnNumber: 15\n    }\n  }, __jsx(\"span\", {\n    className: \"line\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 214,\n      columnNumber: 17\n    }\n  }), __jsx(\"span\", {\n    className: \"text\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 215,\n      columnNumber: 17\n    }\n  }, \"Tampilkan More comment lainnya\"), __jsx(\"span\", {\n    className: \"line\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 216,\n      columnNumber: 17\n    }\n  }))) : null))) : __jsx(\"div\", {\n    className: \"comment-item-component-placeholder\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 224,\n      columnNumber: 7\n    }\n  }, __jsx(\"div\", {\n    className: \"comment-header\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 225,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    className: \"comment-avatar-placeholder\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 226,\n      columnNumber: 11\n    }\n  }, \" \"), __jsx(\"div\", {\n    className: \"comment-user-placeholder\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 227,\n      columnNumber: 11\n    }\n  }, \" \")), __jsx(\"div\", {\n    className: \"comment-body\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 229,\n      columnNumber: 9\n    }\n  }));\n};\n\nexport default CommentItem;","map":null,"metadata":{},"sourceType":"module"}